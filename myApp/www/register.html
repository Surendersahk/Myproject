<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Rescue AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-red-500 to-orange-400 flex items-center justify-center min-h-screen">
  <div class="bg-white bg-opacity-20 p-8 rounded-xl shadow-lg w-96">
    <h2 class="text-2xl font-bold text-center text-white mb-6">Register</h2>

    <form id="registerForm" class="space-y-4">
      <!-- Email Field -->
      <div>
        <label for="email" class="block font-semibold text-sm mb-1 text-white">Email</label>
        <input id="email" type="email" placeholder="Enter your email"
          class="w-full rounded-md bg-white bg-opacity-20 text-white py-2 px-3 placeholder-gray-200" required>
      </div>

      <!-- Username -->
      <div>
        <label for="username" class="block font-semibold text-sm mb-1 text-white">Username</label>
        <input id="username" type="text" placeholder="Enter your username"
          class="w-full rounded-md bg-white bg-opacity-20 text-white py-2 px-3 placeholder-gray-200">
      </div>

      <!-- Password -->
      <div>
        <label for="password" class="block font-semibold text-sm mb-1 text-white">Password</label>
        <input id="password" type="password" placeholder="Enter your password"
          class="w-full rounded-md bg-white bg-opacity-20 text-white py-2 px-3 placeholder-gray-200" required>
      </div>

      <!-- Re-enter Password -->
      <div>
        <label for="confirmPassword" class="block font-semibold text-sm mb-1 text-white">Re-enter Password</label>
        <input id="confirmPassword" type="password" placeholder="Re-enter your password"
          class="w-full rounded-md bg-white bg-opacity-20 text-white py-2 px-3 placeholder-gray-200" required>
      </div>

      <!-- Role selection -->
      <fieldset class="mb-4 text-white">
        <legend class="font-semibold mb-1">Select Your Role</legend>
        <div class="flex items-center mb-2">
          <input type="radio" id="victim" name="role" value="victim" class="mr-2" required>
          <label for="victim">Victim</label>
        </div>
        <div class="flex items-center">
          <input type="radio" id="volunteer" name="role" value="volunteer" class="mr-2" required>
          <label for="volunteer">Volunteer</label>
        </div>
      </fieldset>

      <!-- Submit Button -->
      <button type="submit" id="registerBtn"
        class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 transition disabled:opacity-50">
        Register
      </button>
    </form>

    <p class="text-center text-white text-sm mt-4">
      Already have an account? <a href="login.html" class="font-bold underline hover:text-gray-200">Login</a>
    </p>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB6ehp-gPeTAkET4b5SmjOX24l50KIDGwE",
      authDomain: "helpnet-f5848.firebaseapp.com",
      projectId: "helpnet-f5848",
      storageBucket: "helpnet-f5848.firebasestorage.app",
      messagingSenderId: "340231424827",
      appId: "1:340231424827:web:83c9e84ee23e950cbe851e"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Flags to control behavior
    let isRegistering = false;
    let hasCheckedExistingUser = false;

    // Function to perform redirection
    function performRedirect(role) {
      console.log("Performing redirect to", role, "dashboard");

      // Use window.location.replace instead of href for better reliability
      if (role === "victim") {
        window.location.replace("victim.html");
      } else if (role === "volunteer") {
        window.location.replace("volunteer.html");
      }
    }

    // Wait for DOM to load
    document.addEventListener("DOMContentLoaded", () => {
      const registerForm = document.getElementById("registerForm");
      const registerBtn = document.getElementById("registerBtn");

      if (registerForm) {
        registerForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          if (isRegistering) return; // Prevent multiple submissions
          isRegistering = true;

          // Disable button to prevent multiple clicks
          registerBtn.disabled = true;
          registerBtn.textContent = "Registering...";

          const email = document.getElementById("email").value.trim().toLowerCase();
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const confirmPassword = document.getElementById("confirmPassword").value;
          const role = document.querySelector('input[name="role"]:checked')?.value;

          // Validation
          if (!email || !password || !confirmPassword || !role) {
            alert("⚠️ Please fill in all fields and select a role.");
            resetButton();
            return;
          }

          if (password !== confirmPassword) {
            alert("⚠️ Passwords do not match.");
            resetButton();
            return;
          }

          if (password.length < 6) {
            alert("⚠️ Password should be at least 6 characters long.");
            resetButton();
            return;
          }

          try {
            // Register user with Firebase Auth first
            console.log("Creating user account...");
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            console.log("User created successfully:", user.uid);

            // Store role information for redirect based on registration choice
            localStorage.setItem('userRole', role);
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userName', username);
            localStorage.setItem('userId', user.uid);

            // Store role temporarily for redirect
            sessionStorage.setItem('userRole', role);
            sessionStorage.setItem('justRegistered', 'true');

            // Try to save to Firestore, but don't let it block the redirect
            try {
              console.log("Attempting to save user data to Firestore...");
              await Promise.race([
                setDoc(doc(db, "users", user.uid), {
                  uid: user.uid,
                  email: email,
                  username: username,
                  role: role,
                  createdAt: new Date().toISOString()
                }),
                new Promise((_, reject) =>
                  setTimeout(() => reject(new Error('Firestore timeout')), 3000)
                )
              ]);
              console.log("User data saved successfully to Firestore");
            } catch (firestoreError) {
              console.warn("Failed to save to Firestore, but continuing with redirect:", firestoreError);
              // Don't block the redirect - user is already registered with Auth
            }
            // After registering/logging in the user
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              localStorage.setItem("username", userData.username); // store username
              localStorage.setItem("role", userData.role); // optional, for logic
            }


            // Show success message and redirect based on selected role
            console.log("Redirecting user based on selected role:", role);

            if (role === "victim") {
              alert("✅ Registered Successfully as Victim! Redirecting to Victim Dashboard...");
              setTimeout(() => {
                performRedirect("victim");
              }, 1000);
            } else if (role === "volunteer") {
              alert("✅ Registered Successfully as Volunteer! Redirecting to Volunteer Dashboard...");
              setTimeout(() => {
                performRedirect("volunteer");
              }, 1000);
            } else {
              alert("✅ Registered Successfully! Redirecting to dashboard...");
              setTimeout(() => {
                performRedirect(role);
              }, 1000);
            }

          } catch (error) {
            console.error("❌ Registration Error:", error);

            // Check if it's a network error but auth might have succeeded
            if (error.code === 'auth/network-request-failed') {
              alert("Network error occurred. Please check your connection and try again.");
            } else {
              alert(`Registration failed: ${error.message}`);
            }
            resetButton();
          }
        });
      }

      // Function to reset button state
      function resetButton() {
        isRegistering = false;
        registerBtn.disabled = false;
        registerBtn.textContent = "Register";
      }

      // Check if user is already logged in - but only redirect if they explicitly want to
      onAuthStateChanged(auth, async (user) => {
        // Skip if we're currently registering a new user
        if (isRegistering) {
          console.log("Currently registering, skipping auth state check");
          return;
        }

        if (user && !hasCheckedExistingUser) {
          hasCheckedExistingUser = true;
          console.log("Existing user detected, but staying on registration page");

          // Check if this is a fresh registration (just completed)
          const justRegistered = sessionStorage.getItem('justRegistered');
          const storedRole = sessionStorage.getItem('userRole');

          if (justRegistered && storedRole) {
            console.log("Fresh registration detected, proceeding with redirect");
            // Clear session storage
            sessionStorage.removeItem('justRegistered');
            sessionStorage.removeItem('userRole');
            // Redirect immediately
            performRedirect(storedRole);
            return;
          }

          // For existing users, don't auto-redirect - let them use the form
          console.log("Existing user staying on registration page - no auto-redirect");

          // Optional: Show a message that they're already logged in
          // You can uncomment this if you want to inform the user
          /*
          const existingUserMsg = document.createElement('div');
          existingUserMsg.className = 'text-center text-yellow-200 text-sm mt-2';
          existingUserMsg.innerHTML = '⚠️ You are already logged in. <a href="#" onclick="signOut()" class="underline">Sign out</a> to register a new account.';
          document.querySelector('.bg-white').appendChild(existingUserMsg);
          */
        }
      });

      // Alternative redirect method using a manual check
      const checkRegistrationStatus = () => {
        const justRegistered = sessionStorage.getItem('justRegistered');
        const storedRole = sessionStorage.getItem('userRole');

        if (justRegistered && storedRole) {
          console.log("Manual redirect check triggered");
          sessionStorage.removeItem('justRegistered');
          sessionStorage.removeItem('userRole');
          performRedirect(storedRole);
        }
      };

      // Check every 500ms for 5 seconds as a fallback
      let checkCount = 0;
      const intervalId = setInterval(() => {
        checkRegistrationStatus();
        checkCount++;
        if (checkCount >= 10) { // 5 seconds total
          clearInterval(intervalId);
        }
      }, 500);
    });
  </script>
</body>

</html>